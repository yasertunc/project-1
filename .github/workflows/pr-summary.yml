name: PR Summary

on:
  workflow_run:
    workflows:
      - Storybook Preview
      - lighthouse-ci
      - CI
    types:
      - completed

jobs:
  summary:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Determine PR context
        id: context
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            if (run.event !== "pull_request" || !run.pull_requests?.length) {
              core.setOutput("skip", "true");
              return;
            }
            const pr = run.pull_requests[0];
            core.setOutput("skip", "false");
            core.setOutput("pr", pr.number.toString());
            core.setOutput("head_sha", run.head_sha);

      - name: Checkout PR head
        if: steps.context.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.context.outputs.head_sha }}

      - name: Setup GitHub CLI
        if: steps.context.outputs.skip != 'true'
        run: gh --version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Find preview comment
        if: steps.context.outputs.skip != 'true'
        id: preview-comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ steps.context.outputs.pr }}
          comment-author: github-actions[bot]
          body-includes: "<!-- preview-comment -->"

      - name: Extract preview URL
        if: steps.context.outputs.skip != 'true'
        run: |
          body="${{ steps.preview-comment.outputs.body }}"
          if [ -n "$body" ]; then
            url=$(echo "$body" | grep -o 'https[^ )]*' | head -1)
          fi
          echo "PREVIEW_URL=${url:-N/A}" >> $GITHUB_ENV

      - name: Resolve workflow run IDs
        if: steps.context.outputs.skip != 'true'
        id: runs
        run: |
          set -e
          REPO="${{ github.repository }}"
          HEAD_SHA="${{ steps.context.outputs.head_sha }}"
          get_run() {
            local workflow="$1"
            gh api "repos/$REPO/actions/workflows/$workflow/runs" \
              -f event=pull_request -f per_page=20 \
              --jq ".workflow_runs | map(select(.head_sha == \"$HEAD_SHA\")) | first?.id" || true
          }
          echo "lhci=$(get_run lhci.yml)" >> "$GITHUB_OUTPUT"
          echo "ci=$(get_run ci.yml)" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Lighthouse artifact
        if: steps.context.outputs.skip != 'true' && steps.runs.outputs.lhci != ''
        run: |
          mkdir -p tmp/lhci
          gh run download ${{ steps.runs.outputs.lhci }} --repo ${{ github.repository }} --name lighthouse-reports --dir tmp/lhci || true
          echo "LHCI_DIR=tmp/lhci" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Lychee artifacts
        if: steps.context.outputs.skip != 'true' && steps.runs.outputs.link != ''
        run: |
          mkdir -p tmp/lychee
          gh run download ${{ steps.runs.outputs.link }} --repo ${{ github.repository }} --dir tmp/lychee || true
          echo "LYCHEE_DIR=tmp/lychee" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Evaluate test statuses
        if: steps.context.outputs.skip != 'true'
        run: |
          STATUS="ℹ️ pending"
          if [ -n "${{ steps.runs.outputs.health }}" ]; then
            CONCLUSION=$(gh api repos/${{ github.repository }}/actions/runs/${{ steps.runs.outputs.health }} --jq .conclusion)
            if [ "$CONCLUSION" = "success" ]; then
              STATUS="✅"
            else
              STATUS="❌"
            }
          fi
          echo "TEST_STATUS=$STATUS" >> $GITHUB_ENV
          echo "VR_STATUS=$STATUS" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        if: steps.context.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Generate CI summary
        if: steps.context.outputs.skip != 'true'
        run: node .github/scripts/ci-summary.mjs

      - name: Post CI summary comment
        if: steps.context.outputs.skip != 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ steps.context.outputs.pr }}
          body-path: ci-summary.md
          edit-mode: replace
          comment-tag: ci-summary
