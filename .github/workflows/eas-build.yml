name: EAS Build

on:
  workflow_dispatch:
    inputs:
      platform:
        description: "Target platform"
        required: true
        default: "android"
        type: choice
        options:
          - android
          - ios
          - all
      profile:
        description: "EAS build profile"
        required: true
        default: "production-apk"
        type: choice
        options:
          - production-apk
          - production
  push:
    tags:
      - "v*"

jobs:
  build-android:
    name: Android
    if: ${{ github.event.inputs.platform == 'android' || github.event.inputs.platform == 'all' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/mobile
    env:
      DOWNLOAD_URL: https://www.fellowus.com/download
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: apps/mobile/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install EAS CLI
        run: npm install --global eas-cli@latest

      - name: Prepare service account
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON_BASE64 }}
        run: |
          mkdir -p .eas
          echo "$GOOGLE_SERVICE_ACCOUNT_JSON_BASE64" | base64 -d > .eas/android-service-account.json

      - name: Run EAS build (Android)
        id: build_android
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          PROFILE_INPUT: ${{ github.event.inputs.profile }}
          IS_TAG_PUSH: ${{ github.event_name == 'push' }}
        run: |
          PROFILE="${PROFILE_INPUT:-}"
          if [ "$IS_TAG_PUSH" = "true" ]; then
            PROFILE="production"
          elif [ -z "$PROFILE" ]; then
            PROFILE="production-apk"
          fi
          eas build --platform android --profile "$PROFILE" --non-interactive

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: android-build
          path: apps/mobile/artifacts/**

  build-ios:
    name: iOS
    if: ${{ github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'all' || github.event_name == 'push' }}
    runs-on: macos-latest
    defaults:
      run:
        working-directory: apps/mobile
    env:
      DOWNLOAD_URL: https://www.fellowus.com/download
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: apps/mobile/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install EAS CLI
        run: npm install --global eas-cli@latest

      - name: Run EAS build (iOS)
        id: build_ios
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EXPO_APPLE_APP_STORE_CONNECT_KEY_ID: ${{ secrets.ASC_API_KEY_ID }}
          EXPO_APPLE_APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          EXPO_APPLE_APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.ASC_API_KEY_P8 }}
        run: |
          eas build --platform ios --profile production-ios --non-interactive

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ios-build
          path: apps/mobile/artifacts/**
