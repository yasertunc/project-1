name: Device Matrix Tests

on:
  push:
    branches: [main]
    paths:
      - "apps/mobile/**"
      - ".github/workflows/device-matrix.yml"
  pull_request:
    branches: [main]
    paths:
      - "apps/mobile/**"
      - ".github/workflows/device-matrix.yml"
  schedule:
    - cron: '0 2 * * *' # Daily at 2 AM UTC
  workflow_dispatch:

jobs:
  android-p0-pixel6:
    name: Android P0 - Pixel 6 (API 34)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: |
          cd apps/mobile
          npm ci

      - name: Create Android Virtual Device
        run: |
          echo "y" | sdkmanager "system-images;android-34;google_apis;x86_64"
          echo "no" | avdmanager create avd \
            -n Pixel_6_API_34 \
            -k "system-images;android-34;google_apis;x86_64" \
            -d "pixel_6"

      - name: Start Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          profile: Pixel 6
          script: |
            cd apps/mobile
            npm run build:dev-client:android || true
            # Run smoke tests or manual verification
            echo "Device matrix test completed"

      - name: Capture Screenshots
        if: always()
        run: |
          adb shell screencap -p /sdcard/screen.png
          adb pull /sdcard/screen.png screenshots/pixel6-api34.png || true
          mkdir -p screenshots
        continue-on-error: true

      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pixel6-screenshots
          path: screenshots/
          retention-days: 7

      - name: Collect Logs
        if: always()
        run: |
          adb logcat -d > logs/pixel6-api34.log || true
          mkdir -p logs
        continue-on-error: true

      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pixel6-logs
          path: logs/
          retention-days: 7

  android-p1-pixel5:
    name: Android P1 - Pixel 5 (API 32)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: |
          cd apps/mobile
          npm ci

      - name: Create Android Virtual Device
        run: |
          echo "y" | sdkmanager "system-images;android-32;google_apis;x86_64"
          echo "no" | avdmanager create avd \
            -n Pixel_5_API_32 \
            -k "system-images;android-32;google_apis;x86_64" \
            -d "pixel_5"

      - name: Start Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 32
          arch: x86_64
          profile: Pixel 5
          script: |
            cd apps/mobile
            npm run build:dev-client:android || true
            # Run smoke tests or manual verification
            echo "Device matrix test completed"

      - name: Capture Screenshots
        if: always()
        run: |
          adb shell screencap -p /sdcard/screen.png
          adb pull /sdcard/screen.png screenshots/pixel5-api32.png || true
          mkdir -p screenshots
        continue-on-error: true

      - name: Upload Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pixel5-screenshots
          path: screenshots/
          retention-days: 7

      - name: Collect Logs
        if: always()
        run: |
          adb logcat -d > logs/pixel5-api32.log || true
          mkdir -p logs
        continue-on-error: true

      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pixel5-logs
          path: logs/
          retention-days: 7

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [android-p0-pixel6, android-p1-pixel5]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate Test Summary
        run: |
          echo "## Device Matrix Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### P0 Devices" >> $GITHUB_STEP_SUMMARY
          echo "- Pixel 6 (API 34): ${{ needs.android-p0-pixel6.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### P1 Devices" >> $GITHUB_STEP_SUMMARY
          echo "- Pixel 5 (API 32): ${{ needs.android-p1-pixel5.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Screenshots and logs are available in the workflow artifacts." >> $GITHUB_STEP_SUMMARY
