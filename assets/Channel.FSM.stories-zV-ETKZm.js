import{j as n}from"./jsx-runtime-BjG_zV1W.js";import{within as x,userEvent as w}from"./index-CLEdRh-S.js";import{A as T}from"./AppShell-Cc01PSbU.js";import{r as a}from"./index-BfiH1CDa.js";import{C as b}from"./ChannelStatusBanner-Ds-c2FbI.js";import{A as y}from"./AcceptanceOffer-ChToTJNx.js";import"./LanguageSwitcher-DUvom60D.js";import"./_commonjsHelpers-Cpj98o6Y.js";class f{constructor(){this.listeners=new Set}on(t){return this.listeners.add(t),()=>this.listeners.delete(t)}emit(t){for(const i of[...this.listeners])i(t)}clear(){this.listeners.clear()}}class k{constructor(){this.bus=new f,this.connected=!1,this.timers=[]}connect(){if(this.connected)return;this.connected=!0;const t=setTimeout(()=>this.bus.emit({type:"connected"}),50);this.timers.push(t);const i=setTimeout(()=>{this.bus.emit({type:"offer",matchId:"m_ws_1",participants:["u_demo","u_peer"],score:.84})},300);this.timers.push(i)}send(t){if(this.connected){if(t.type==="ackOffer"){const i=setTimeout(()=>{this.connected&&this.bus.emit({type:"channelOpen",channelId:"ch_ws_1"})},350);this.timers.push(i)}t.type==="close"&&this.close()}}on(t){return this.bus.on(t)}close(){this.connected&&(this.connected=!1,this.timers.forEach(clearTimeout),this.timers=[],this.bus.clear())}}class S{constructor(){this.bus=new f,this.timers=[],this.subscribed=!1}subscribe(){if(this.subscribed)return;this.subscribed=!0;const t=setTimeout(()=>{this.bus.emit({type:"pushOffer",matchId:"m_fcm_1",participants:["u_demo","u_peer"],score:.81})},600);this.timers.push(t)}on(t){return this.bus.on(t)}tearDown(){this.timers.forEach(clearTimeout),this.timers=[],this.bus.clear(),this.subscribed=!1}}class g{constructor(){this.ws=new k,this.fcm=new S,this.subscriptions=new Set,this.snapshot={phase:"idle",ctx:{}},this.started=!1,this.teardown=[]}subscribe(t){return this.subscriptions.add(t),t(this.snapshot),()=>this.subscriptions.delete(t)}getSnapshot(){return this.snapshot}start(){if(this.started)return;this.started=!0;const t=this.ws.on(e=>{e.type==="offer"?this.receiveOffer(e.matchId,e.participants,e.score):e.type==="channelOpen"?this.toOpen(e.channelId):e.type==="error"&&this.toError(e.code)}),i=this.fcm.on(e=>{e.type==="pushOffer"&&this.snapshot.phase==="idle"?this.receiveOffer(e.matchId,e.participants,e.score):e.type==="deliveryError"&&this.toError(e.code)});this.teardown.push(t,i),this.ws.connect(),this.fcm.subscribe()}dispose(){this.ackTimer&&clearTimeout(this.ackTimer),this.teardown.forEach(t=>t()),this.teardown=[],this.ws.close(),this.fcm.tearDown(),this.started=!1,this.reset()}acceptOffer(){if(this.snapshot.phase!=="offer_received"||!this.snapshot.ctx.matchId)return;const{matchId:t}=this.snapshot.ctx;this.transition({phase:"awaiting_ack",ctx:{...this.snapshot.ctx}}),this.ws.send({type:"ackOffer",matchId:t}),this.ackTimer&&clearTimeout(this.ackTimer),this.ackTimer=setTimeout(()=>{this.snapshot.phase==="awaiting_ack"&&this.toError("ACK_TIMEOUT")},5e3);const i=setTimeout(()=>{this.snapshot.phase==="awaiting_ack"&&this.transition({phase:"opening",ctx:{...this.snapshot.ctx}})},150);this.teardown.push(()=>clearTimeout(i))}declineOffer(){this.snapshot.phase==="offer_received"&&this.transition({phase:"declined",ctx:{...this.snapshot.ctx}})}reset(){this.ackTimer&&clearTimeout(this.ackTimer),this.ackTimer=void 0,this.transition({phase:"idle",ctx:{}})}receiveOffer(t,i,e){this.snapshot.phase==="idle"&&this.transition({phase:"offer_received",ctx:{matchId:t,participants:i,score:e}})}toOpen(t){this.ackTimer&&clearTimeout(this.ackTimer),this.transition({phase:"open",ctx:{...this.snapshot.ctx,channelId:t}})}toError(t){this.ackTimer&&clearTimeout(this.ackTimer),this.transition({phase:"error",ctx:{...this.snapshot.ctx,errorCode:t}})}transition(t){this.snapshot=t;for(const i of[...this.subscriptions])i(this.snapshot)}}const p=s=>{switch(s.phase){case"awaiting_ack":case"opening":return"opening";case"open":return"open";case"error":return"error";default:return"idle"}},v=s=>{let t=p(s.getSnapshot());const i=new Set;return{state(){return t},async open(){const e=s.getSnapshot().ctx;return{channelId:e.channelId??`pending-${e.matchId??Math.random().toString(36)}`}},async close(){s.reset()},onState(e){return i.add(e),e(t),()=>i.delete(e)},update(e){const r=p(e);r!==t&&(t=r,i.forEach(o=>o(r)))}}},m=()=>{const s=a.useMemo(()=>new g,[]),[t,i]=a.useState(s.getSnapshot()),e=a.useMemo(()=>v(s),[s]);a.useEffect(()=>{const o=s.subscribe(h=>{i(h),e.update(h)});return()=>o()},[s,e]),a.useEffect(()=>(s.start(),()=>{s.dispose()}),[s]);const r=t.phase==="awaiting_ack"||t.phase==="opening";return n.jsxs("div",{className:"grid w-[460px] gap-12",children:[n.jsx(b,{svc:e}),t.phase==="idle"&&n.jsx("div",{className:"text-sm text-[color:var(--ink-700)]",children:"Waiting for an offerâ€¦"}),t.phase==="offer_received"&&t.ctx.matchId&&t.ctx.participants&&typeof t.ctx.score=="number"&&n.jsx(y,{offer:{matchId:t.ctx.matchId,participants:t.ctx.participants,score:{total:t.ctx.score}},onAccept:()=>s.acceptOffer(),onDecline:()=>s.declineOffer(),busy:r}),t.phase==="open"&&t.ctx.channelId&&n.jsxs("div",{role:"status",className:"rounded-xl bg-[color:var(--color-success-100,#dcfce7)] px-3 py-2 text-sm font-medium text-[color:var(--color-success-900,#14532d)]",children:["Channel open (id: ",t.ctx.channelId,")"]}),t.phase==="declined"&&n.jsx("div",{role:"status",className:"text-sm text-[color:var(--ink-800)]",children:"Offer declined."}),t.phase==="error"&&n.jsxs("div",{role:"status",className:"text-sm text-[color:var(--color-danger-700,#b91c1c)]",children:["Error: ",t.ctx.errorCode]})]})};m.__docgenInfo={description:"",methods:[],displayName:"ChannelController"};const A={title:"Fellowus/Channel/FSM",parameters:{layout:"fullscreen"}},c={render:()=>n.jsx(T,{title:"Channel FSM Demo",children:n.jsx(m,{})}),play:async({canvasElement:s})=>{const t=x(s);await t.findByText(/offer score/i,void 0,{timeout:3e3});const i=await t.findByRole("button",{name:/accept/i});await w.click(i),await t.findByText(/opening channel/i),await t.findByText(/channel open \(id:/i,void 0,{timeout:3e3})}};var d,l,u;c.parameters={...c.parameters,docs:{...(d=c.parameters)==null?void 0:d.docs,source:{originalSource:`{
  render: () => <AppShell title="Channel FSM Demo">
      <ChannelController />
    </AppShell>,
  play: async ({
    canvasElement
  }) => {
    const canvas = within(canvasElement);
    await canvas.findByText(/offer score/i, undefined, {
      timeout: 3000
    });
    const acceptButton = await canvas.findByRole("button", {
      name: /accept/i
    });
    await userEvent.click(acceptButton);
    await canvas.findByText(/opening channel/i);
    await canvas.findByText(/channel open \\(id:/i, undefined, {
      timeout: 3000
    });
  }
}`,...(u=(l=c.parameters)==null?void 0:l.docs)==null?void 0:u.source}}};const F=["WebSocketAndFCM"];export{c as WebSocketAndFCM,F as __namedExportsOrder,A as default};
